@using DominosPizza.Models
@model IEnumerable<Task>

@{
    Layout = "~/Views/Crmpanel/_LayoutKitchen.cshtml";
    var db = new DominosContext();
}

<section class="panel">
    <header class="panel-heading">
        <h2 class="panel-title">Заказы в работе</h2>
    </header>
    <div class="panel-body">
        <table class="table table-bordered table-striped mb-none" id="datatable-default">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ФИО</th>
                    <th>Дата заказа</th>
                    <th>Сумма заказа</th>
                    <th>Адрес доставки</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var task = db.Tasks.Find(item.TaskId);
                    if (task != null)
                    {
                        ViewBag.taskId = item.TaskId;
                        ViewBag.totalSumm = item.TaskTotalSum;
                        ViewBag.date = item.TaskDate;
                        ViewBag.status = item.TaskStatus;

                        var contact = db.Contacts.Find(task.ContactId);
                        if (contact != null)
                        {
                            ViewBag.adress = contact.ContactAddress; // вытаскиваем адрес доставки пиццы
                        }

                        var customer = db.Customers.Find(task.CustomerId); // вытаскиваем кастомера из заказа
                        if (customer != null)
                        {
                            ViewBag.customer = customer.CustomerFullName();
                        }
                    }
                    <!-- если заказ не завершен или не отменен, то вывести список текущих заказов -->
                    if (item.TaskStatus == "kitchen")
                    {
                        <tr>
                            <td>@ViewBag.taskId</td>
                            <td>@ViewBag.customer</td>
                            <td>@ViewBag.date</td>
                            <td>@ViewBag.totalSumm</td>
                            <td>@ViewBag.adress</td>
                            <td>@ViewBag.status</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</section>